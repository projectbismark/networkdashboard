{% extends "base.html" %}
{% block content %}

<div class ="section" id="section_1">
    <h1>BISMark Device           <a href ="/editDevicePage/{{detail.hashkey}}"> Edit </a></h1>
    <script src="/static/jquery-latest.js"></script>
    <script src="/static/highcharts.js"></script>
    <script src="/static/js/modules/exporting.js"></script>


    <table>
	<!--
        <tr><td>MAC Address</td><td>{{ detail.macid }}</td></tr>
        <tr><td>Type</td><td>{{ detail.type }}</td></tr>
        <tr><td>Operating System</td><td>{{ detail.os }}</td></tr> -->
        <tr><td><b>Name</b></td><td><b>{{ detail.name }}</b></td></tr>
        <tr><td>ISP</td><td>{{ detail.isp }}</td></tr>
        <tr><td>Location</td><td><div id="location{{ deviceid }}"></div><script type="text/javascript">

		$.ajax({
                type: "GET",
                url: escape("/getLocation/{{ deviceid }}/"),
                success: OnSuccess
            });
		
		function OnSuccess(data)
		{
		document.getElementById('location{{ deviceid }}').innerHTML = data;
		}

		</script></td>
        </tr>     
        <tr><td>Service Plan</td><td>{{ detail.serviceplan }}</td></tr>
        <tr><td>Download Rate</td><td>{{ detail.downloadrate}} kbps</td></tr>
        <tr><td>Upload Rate</td><td>{{ detail.uploadrate}} kbps</td></tr>
    
 
  
        
	

<tr><td>First Measurement</td><td>{{ firstUpdate }}</td></tr>
<tr><td>Last Measurement</td><td>{{ lastUpdate }}</td></tr>

 
<tr><td>Raw Data</td></td><td><a href="http://projectbismark.net/data/{{ deviceid }}">Download XML</a></td></tr>
<script type="text/javascript">
    function convertURL(name){
        return encodeURIComponent(name);
    }
</script>
<tr><td>URL for this device page</td><td><input id="url" type="text" style="width:320px;" value="http://networkdashboard.org/displayDevice/{{ detail.hashkey }}" ></td>
</table>

</div>
<div class="section" id="section_2">

<script type="text/javascript" src="/static/dygraph-combined.js"></script>


<body class=" claro " onload="CloseProgressBar()">


<table border="0"> 

<tr>
<td>
<input type="radio" name="g1" id="g1rb3" checked>
<label for="g1rb3">Upload and Download Throughput (kbps)</label><br/><br/>
<input type="radio" name="g1" id="g1rb2">
<label for="g1rb2">Last-Mile Latency (ms)</label><br/><br/>
<input type="radio" name="g1" id="g1rb1">
<label for="g1rb1">Round Trip Time (ms)</label><br/><br/>
<input type="radio" name="g1" id="g1rb4">
<label for="g1rb1">Passive Measurements</label><br/><br/>


</td>
<td>


</td>
<tr/>

</table>
<div class="menu" id="drop_menu_1">
    Compare to other devices based on:<br/>
    <select id="select_menu_1">
        <option value = "none" selected>Don't Compare</option>
        <option value ="location">Location({{num_location}})</option>
        <option value ="provider">Provider({{num_provider}})</option>
    </select>
</div>
<div class="menu" id ="drop_menu_2">
    Bucket Size:<br/>
    <select id="select_menu_2">
        <option value = "hourly" selected>Hourly</option>
        <option value ="daily"> Daily </option>
        <option value ="weekly"> Weekly </option>
    </select>
</div>
        
<br />
<button type="submit" name="submit" onClick=" render()">Display</button>

</div>


        

<br />
<div class="progresscontainer">
    <div class="progressbar" id="progress" indeterminate="true" title="loading" ></div>
</div>
<br /><br /><br />
<div class ="graphdisplay" id = "display_tag" >
    <div id="graph_place_holder" style="width:600px; height: 300px;"></div>
</div>
    
<!--    <div class ="radiodiv"
    <input type="radio" name = "mode" id="lin" onClick="setDisplayMode(false)" checked>
    <label for="lin">Linear</label>

    <input type="radio" name = "mode" id="log" onClick ="setDisplayMode(true)">
    <label for="log">Log</label><br /><br />
    </div>-->
<script type="text/javascript">

	var content="[not loaded]";
	var limit = 1000000;
	var units = "kbps";
	var paramselect = "AGGL3BITRATE";
        var logdisplay = false;
        var special = false;
        var filter = "none";
        var bucket = "hourly";

       	render();
	
	function createStyle()
	{
            var sel = document.getElementById("select_menu_1");
            var sel2 = document.getElementById("select_menu_2");
            filter = sel.options[sel.selectedIndex].value;
            bucket = sel2.options[sel2.selectedIndex].value;

		if(g1rb1.checked)
		{
			limit = 1000;
			units = "msec";
			paramselect = "RTT";
                        special = true;
		}
		else if(g1rb2.checked)
		{
			limit = 1000;
			units = "msec";
			paramselect = "LMRTT";
                        special = true;
		}
		else if(g1rb3.checked)
		{
			limit = 1000000;
			units = "kbps";
			paramselect = "AGGL3BITRATE";
                        special = false;
		}
                else if(g1rb4.checked)
                {
                        paramselect = "PASSIVE";
                }
                 
	}

        function OnSuccess(data)
        {
//          content=data;
//
//	  if(content.length<=60){
//		deleteDivs();
//		var dtag = document.getElementById('display_tag');
//		dtag.setAttribute('value', 'Insufficient Data');
//		}
//	  else{
//
//             g = new Dygraph(document.getElementById("graph_div_1"),
//                       content,
//                       {
//                       rollPeriod: 1,
//                       showRoller: true,
//                       logscale: (logdisplay&&special),
//                       errorBars: false,
//                       connectSeparatedPoints: true,
//		       colorValue: 0.0 
//                       }
//                       );
//		
//		addRadios();
//        	addLabels();
//
//		}
	  
         var content = data;
         chart = new Highcharts.Chart({
            chart: {
                    renderTo: 'graph_div_1',
                    type: 'spline'
            },
            title: {
                    text: 'Download Throughput'
            },
            xAxis: {
                    type: 'datetime'
//                    dateTimeLabelFormats: {
//                            month: '%e. %b',
//                            year: '%b'
//                    }
            },
            yAxis: {
                    title: {
                            text: 'Throughput (kbps)'
                    },
                    min: 0
            },
            series: [{
                    name: 'series 1',

//                    data:eval('[["2011-10-19 18:16:35", 0],["2011-10-19 18:17:23", 0.6],["2011-10-19 18:40:52", 0.7],["2011-10-19 18:44:58", 0.8],["2011-10-19 18:48:25", 0.6]]')
                    data:eval(content)
        
                                                        
            }]
         });


	 CloseProgressBar();
         
        }
         
         function OnSuccess2(data)
        {
          content=data;

	  if(content.length<=50){


		}	  
	  else{
	         g2 = new Dygraph(document.getElementById("graph_div_2"),
			   content,
			   {
	      		   rollPeriod: 1,
	      		   showRoller: true,
                           logscale: (logdisplay&&special),
                           connectSeparatedPoints: true,
                           errorBars: false
	    		   }
			   );
	  }
	 CloseProgressBar();
        }
        
        function OnSuccess3(data){
            CloseProgressBar();
            chart = new Highcharts.Chart({
                chart: {
                        renderTo: 'graph_div_1',
                        defaultSeriesType: 'bar'
                },
                title: {
                        text: 'Passive Data'
                },
                
                xAxis: {
                        categories: ['cat1', 'cat2', 'cat3', 'cat4', 'cat5'],
                        title: {
                                text: null
                        }
                },
                yAxis: {
                        min: 0,
                        title: {
                                text: 'Population (millions)',
                                align: 'high'
                        }
                },
                tooltip: {
                        formatter: function() {
                                return ''+
                                         this.series.name +': '+ this.y +' millions';
                        }
                },
                plotOptions: {
                        bar: {
                                dataLabels: {
                                        enabled: true
                                }
                        }
                },
                legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'top',
                        x: -100,
                        y: 100,
                        floating: true,
                        borderWidth: 1,
                        backgroundColor: '#FFFFFF',
                        shadow: true
                },

                credits: {
                        enabled: false
                },
                series: data
        });
		

            
        }
        
        function setDisplayMode(log){
            g.updateOptions({logscale:log})
            logdisplay = log;
        }
        
        function convertURL(name){
            return encodeURIComponent(name);
        }
        

	
        function OnError(data)
        {
	  alert("data loading failed");
        }
        
        function deleteDivs(){
            
            var dtag = document.getElementById('display_tag');
            while(dtag.hasChildNodes()){
                dtag.removeChild(dtag.lastChild);
            }  
        }
        
        function createGraphDivs(){
            var dtag = document.getElementById('display_tag');
            var outer = document.createElement('div');
            outer.setAttribute('id','graph_div_outer');
            outer.setAttribute('class','outergraphdiv');
            var gd1 = document.createElement('div');
            gd1.setAttribute('id','graph_div_1');
            gd1.setAttribute('class','graphdiv');
            outer.appendChild(gd1);
            dtag.appendChild(outer);
            if (paramselect == 'AGGL3BITRATE'){
                outer = document.createElement('div');
                outer.setAttribute('id','graph_div_outer2');
                outer.setAttribute('class','outergraphdiv');
                var gd2 = document.createElement('div');
                gd2.setAttribute('id','graph_div_2');
                gd2.setAttribute('class','graphdiv');

                outer.appendChild(gd2);
                dtag.appendChild(outer);
            }
            
        }
        
        function addRadios(){
            setDisplayMode(false);
            if(document.getElementById('lin')){
                return;
            }
            if(paramselect=='AGGL3BITRATE'){
                return;
            }
            var dtag = document.getElementById('graph_div_outer');
            var rdiv = document.createElement('div');
            rdiv.setAttribute('class','radiodiv');
            rdiv.setAttribute('id', 'radio_div');
            var r1 = "<input type='radio' name = 'mode' id='lin' onClick='setDisplayMode(false)' checked>";
            var r2 = "<input type='radio' name = 'mode' id='log' onClick='setDisplayMode(true)'>";
            rdiv.innerHTML = "Linear: ";
            rdiv.innerHTML += r1;
            rdiv.innerHTML += "Log: ";
            rdiv.innerHTML += r2;
            dtag.appendChild(rdiv);
        }
        
        
        function addLabels(){
            
            if(document.getElementById('label_1')){
                return;
            }
            var outer1 = document.getElementById('graph_div_outer');
            var label1 = document.createElement('div');
            
            if(paramselect == "AGGL3BITRATE"){
                var outer2 = document.getElementById('graph_div_outer2');
                label1.innerHTML = '<b>Download Throughput (kbps)</b> <br />';
                var label2 = document.createElement('div');
                label2.innerHTML = '<br/><br/><b>Upload Throughput (kbps)</b><br />';
                label2.setAttribute('id','label_2');
                label2.setAttribute('align','center');
                outer2.appendChild(label2);
            }
            else if(paramselect == "RTT"){
                label1.innerHTML = '<b> Round Trip Time (msec)</b><br />';
            }
            else if(paramselect == "LMRTT"){
                label1.innerHTML = '<b> Last-Mile Latency (msec)</b><br />';
            }
            
            label1.setAttribute('id','label_1');
            label1.setAttribute('align','center');
            outer1.appendChild(label1);
            
        }
           
	function render()
	{

        createStyle();
        deleteDivs();
        createGraphDivs();
	OpenProgressBar();
	
        if (paramselect=="PASSIVE"){
//            $.ajax({
//                        type: "GET",
//                        url: "/passive_data_chart/",
//                        data: {'graphno' : 1, 'deviceid': "{{deviceid}}", 'filter_by': filter, 'bucket_size': bucket},
//                        success: OnSuccess3
//                    });
				
            $.get('/static/total.csv', function(data) {
				// Split the lines
				var lines = data.split('\n');
                var points = [];

				$.each(lines, function(lineNo, line) {
					var items = line.split(',');
                    if (items.length == 6) {
                        points.push([ Date.UTC(parseInt(items[0]),
                                               parseInt(items[1]),
                                               parseInt(items[2]),
                                               parseInt(items[3]),
                                               parseInt(items[4])),
                                    parseFloat(items[5]) ]);
                    }
				});

				var chart = new Highcharts.StockChart({
				    chart: {
				    	renderTo: 'graph_div_1',
                        alignTicks: false
				    },
                    rangeSelector: {
                        buttons: [{
                            type: 'day',
                            count: 1,
                            text: 'day'
                        }, {
                            type: 'week',
                            count: 1,
                            text: 'week'
                        }, {
                            type: 'all',
                            count: 1,
                            text: 'all'
                        }],
                        selected: 1
                    },
				    title: {
				    	text: 'Aggregate home network traffic'
				    },
				    xAxis: {
                        title: {
                            text: 'Time'
                        },
                        type: 'datetime',
                        maxZoom: 86400 * 1000
                    },
                    yAxis: {
                        title: {
                            text: 'Bytes transferred'
                        },
                    },
                    tooltip: {
                        formatter: function() {
                            var format = '%A, %b %e, %Y, %H:%M';
                            var value = this.points[0].y;
                            var unit = 'bytes';
                            if (value > 1000) {
                                value /= 1000;
                                unit = 'KiB';
                            }
                            if (value > 1000) {
                                value /= 1000;
                                unit = 'MiB';
                            }
                            if (value > 1000) {
                                value /= 1000;
                                unit = 'GiB';
                            }
                            return '<b>'
                                + Highcharts.dateFormat(format, this.x)
                                + '</b><br/>' + value.toFixed(1) + ' ' + unit;
                        }
                    },
                    series: [{
                        type: 'column',
                        name: 'traffic',
                        data: points,
                    }]
                });
            });




            CloseProgressBar();
        }
        else {


	    if(paramselect=="AGGL3BITRATE"){
//                $.ajax({
//                        type: "GET",
//                        url: "/getThroughput/",
//                        data: {'graphno' : 2, 'deviceid': "{{deviceid}}", 'filter_by': filter, 'bucket_size': bucket},
//                        success: OnSuccess2
//                    });

		$.ajax({
                        type: "GET",
                        url: "/getThroughput/",
                        data: {'graphno' : 1, 'deviceid': "{{deviceid}}", 'filter_by': filter, 'bucket_size': bucket},
                        success: OnSuccess
                    });
            }
	    else if(paramselect=="LMRTT") {
            $.ajax({
                        type: "GET",
                        url: "/line_lmrtt/",
                         data: {'deviceid': "{{deviceid}}", 'filter_by': filter, 'bucket_size': bucket},
                        success: OnSuccess
                    });
  		}
		
	    else{
            $.ajax({
                        type: "GET",
                        url: "/compare_data_chart/{{deviceid}}",
                        data: {'graphno' : 1,'param':paramselect, 'deviceid': "{{deviceid}}", 'start': "08/01/2011", 'end': "12/01/2011", 'filter_by': filter, 'bucket_size': bucket},
                        success: OnSuccess
                    });
  		}
        }
        
        }

	function CloseProgressBar() {
		    var progressbar_container = document.getElementById("progress");
                    progressbar_container.style.display="none";
		    //document.getElementById("graph_div").display = "block";
		
        }

	function OpenProgressBar() {
		var progressbar_container = document.getElementById("progress");
                progressbar_container.style.display="block";
		    
            
        }

</script>
</body>


{% endblock %}
